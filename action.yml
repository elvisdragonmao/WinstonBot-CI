name: Winston Bot ä¸­æ–‡æª¢æŸ¥
author: Elvis Mao
description: æ‹¼å¯«éŒ¯èª¤ã€å°ˆæœ‰åè©å¤§å°å¯«ã€ä¸­åœ‹æ”¿æ²»è‰²å½©ç”¨èªæª¢æŸ¥å·¥å…·
branding:
  color: gray-dark
  icon: file-text

inputs:
  exts:
    description: "File extensions to check (comma separated)"
    default: "md"
    required: false
  github_token:
    description: "GitHub Token for pushing commits"
    required: false

runs:
  using: "composite"
  steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Set up Node.js
      uses: actions/setup-node@v4
      with:
        node-version: "22"

    - name: Install autocorrect
      shell: bash
      run: npm install autocorrect-node

    - name: Run autocorrect
      run: npx autocorrect --fix
      shell: bash
      continue-on-error: true

    - name: No space & rename æ¯›å“¥EM
      run: |
        find . -type f -exec sed -i \
          -e 's/æ¯›å“¥ EM/æ¯›å“¥EM/g' \
          -e 's/æ¯›å“¥EM è³‡è¨Šå¯†æŠ€/æ¯›å“¥EMè³‡è¨Šå¯†æŠ€/g' \
          {} +
      shell: bash
      continue-on-error: true

    - name: Commit autocorrected files
      shell: bash
      run: |
        git config --global user.name "github-actions"
        git config --global user.email "actions@github.com"
        git add .
        git restore --staged package.json .github
        git restore package.json .github
        if git diff --staged --quiet; then
          echo "No changes to commit"
        else
          git commit -m "style: ä½ å€‘ç‚ºç”šéº¼å°±ä¸èƒ½åŠ å€‹ç©ºç™½å‘¢ï¼Ÿ"
          git push
        fi
      env:
        GITHUB_TOKEN: ${{ inputs.github_token }}
      continue-on-error: true

    - name: Install jq & parallel
      run: |
        sudo apt-get update -y
        sudo apt-get install -y jq parallel
      shell: bash

    - name: Check files with Winston API
      shell: bash
      working-directory: ${{ github.workspace }}
      run: |
        set -e
        API_URL="https://winston.emtech.cc/api/check"
        mkdir -p logs
        echo "ğŸ” Searching ${{ inputs.exts }} files..."
        IFS=',' read -r -a EXT_ARR <<< "${{ inputs.exts }}"
        EXT_REGEX=$(IFS='|'; echo "${EXT_ARR[*]}")
        mapfile -t FILES < <(
          git ls-files | grep -E "\.(${EXT_REGEX})$"
        )
        echo "Found ${#FILES[@]} files"
        if [ ${#FILES[@]} -eq 0 ]; then
          echo "âš ï¸ No ${{ inputs.exts }} files found"
          exit 0
        fi

        echo "ğŸš€ Running checks in parallel for ${#FILES[@]} files..."
        error_flag=0
        check_file() {
          local file="$1"
          local text
          text=$(jq -Rs . < "$file")
          local response
          response=$(curl -s -X POST "$API_URL" \
            -H "Content-Type: application/json" \
            -d "{\"text\": $text}")

          if echo "$response" | jq -e '.mistakes | length > 0' >/dev/null; then
            echo "âŒ [$file]"
            echo "$response" | jq -r '.mistakes[] |
              if .type == "spelling_correction" or .type == "case" or .type == "political_terminology" or .type == "regional_difference" then
                "ã€Œ\(.wrong)ã€â†’ã€Œ\(.correct | join("ã€"))ã€ âŒ"
              elif .type == "term_ambiguity_check" then
                "âš ï¸ ä½ ç¢ºå®šä½ æƒ³èªªçš„æ˜¯ã€Œ\(.wrong)ã€è€Œä¸æ˜¯ã€Œ\(.correct | join("ã€"))ã€å—ï¼Ÿ"
              else
                "âš ï¸ å…¶ä»–é¡å‹ï¼š\(.type) - \(.wrong) â†’ \(.correct | join("ã€"))"
              end' | tee -a logs/winston.log
            # æª¢æŸ¥æ˜¯å¦æœ‰åš´é‡éŒ¯èª¤é¡å‹
            if echo "$response" | jq -e '.mistakes[] | select(.type != "term_ambiguity_check")' >/dev/null; then
              echo "â— Error found in $file"
              echo "$file" >> logs/error_files.txt
            fi
          else
            echo "âœ… [$file] OK"
          fi
        }
        export -f check_file
        export API_URL

        parallel -j 10 check_file ::: "${FILES[@]}"

        if [ -s logs/error_files.txt ]; then
          echo "ğŸš« Winston Bot æª¢æŸ¥æœªé€šéï¼šä»¥ä¸‹æ–‡ä»¶å­˜åœ¨éŒ¯èª¤"
          cat logs/error_files.txt
          exit 1
        else
          echo "âœ… Winston Bot æª¢æŸ¥å®Œæˆï¼šåƒ…æœ‰ warning æˆ–å…¨æ•¸é€šé"
        fi
